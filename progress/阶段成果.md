# 现阶段成果（智能机械臂控制软件 - 调试支撑版）

更新时间：2025-12-23

## 已实现内容总览

### 1) 串口协议与无硬件模拟（可在没有机械臂时验证链路）
- **协议打包/解析**：已实现 `0x03`（写舵机位置）、`0x15`（读舵机位置）的帧打包与解析，支持前导噪声、粘包/拆包。
  - 关键文件：`ArmProtocol.h`、`ArmProtocol.cpp`
- **进程内串口模拟器**：可在没有机械臂时模拟“舵机状态+回包”，并支持注入延迟/丢包/坏包用于压力测试。
  - 关键文件：`FakeSerialPort.h`、`FakeSerialPort.cpp`

### 2) 串口诊断页（可见性：看得见 TX/RX、能导出日志、能现场调试）
- 入口：主界面点击 **“诊断(&D)…”** → `Serial` 页
- 功能：
  - **COM 口枚举**（注册表枚举）
  - **连接/断开**
    - 支持 **模拟串口/真实串口**切换，且切换过程做了清理避免句柄泄漏
  - **单舵机调试面板（新增）**
    - **手动控制**：ID / Pos / Step / Time 参数输入
    - **步进微调**：支持 **+步/-步** 按钮，每次只动一点点
    - **安全边界（Min/Max）**：可现场设置每个舵机的软限位，防止误操作撞击
    - **单路回读**：点击“读取ID”只读当前舵机，日志解析会显示具体角度
  - **发送测试帧**
    - Move 示例：发送 `Move(舵机1 → 500, 800ms)`
    - Read 示例：发送 `Read(1..6)` 并显示回包
  - **十六进制监视**
    - `[TX] ...` `[RX] ...` 以 HEX 显示字节流
  - **协议解析摘要**
    - `[PARSE] cmd=...` 显示指令、舵机数、时间等摘要
    - **详细回读**：对于 0x15 响应，直接打印 `[1=500, 2=512...]` 方便对比
  - **日志导出**（txt）
- 关键文件：
  - UI：`SerialDiagPage.h`、`SerialDiagPage.cpp`
  - 真实串口封装：`SerialPortWin32.h`、`SerialPortWin32.cpp`

### 3) 摄像头诊断页（适配“摄像头可能调整位置”的调试需求）
- 入口：主界面点击 **“诊断(&D)…”** → `Camera` 页
- 功能：
  - **摄像头枚举**（Media Foundation：`MFEnumDeviceSources`）
  - **开始/停止预览**
  - **帧率估算（FPS）**：每秒计算一次
  - **截图**：保存 BMP（用于对比安装位置变化前后）
  - **预览错误捕获**：通过 `WM_APP_PREVIEW_ERROR` 写日志并停止预览
  - **位置变化快速适配**
    - **镜像（Mirror）**
    - **旋转（0/90/180/270）**
    - **十字线（Crosshair）**
    - **九宫格参考线（Grid）**
    - 上述设置会**持久化保存**（下次打开仍生效）
  - **无摄像头/初始化失败 fallback**
    - 当摄像头创建/SetDevice 失败，会自动进入 **Test source** 模式（用于无设备时仍能验证 UI/截图/流程）
- 关键文件：
  - 诊断页：`CameraDiagPage.h`、`CameraDiagPage.cpp`
  - 预览管线（MF SourceReader 回调）：`preview.h`、`preview.cpp`
  - D3D9 渲染/叠加：`device.h`、`device.cpp`、`BufferLock.h`、`MFCaptureD3D.h`

### 4) 节流/控制诊断页（真实节流与统计）
- 入口：主界面点击 **“诊断(&D)…”** → `Control` 页
- 功能：
  - **节流周期调参**：30~100ms（并持久化）
  - **真实发送队列控制**：串口页的所有发送操作（包括快速点击步进）都会进入队列，严格按照设定的节流周期发出。
  - **实时统计**：
    - **Send rate**：显示真实的发送帧率（FPS）
    - **Last send**：显示距离上次发送过去了多少毫秒
- 关键文件：`ControlDiagPage.h`、`ControlDiagPage.cpp`、`智能机械臂.cpp` (App级统计)

### 5) 统一入口：诊断中心（PropertySheet）
- 主界面新增按钮：**“诊断(&D)…”**，弹出诊断中心（四页：Serial / Camera / Control / Motion）
- 关键文件：`DiagnosticsSheet.h`、`DiagnosticsSheet.cpp`
- 资源与控件：`My.rc`、`Resource.h`

### 6) 运动控制层与逻辑（新增：解耦控制与多关节联动）
- **通信服务层 (ArmCommsService)**：将串口连接、TX 队列节流、RX 解析、日志广播等逻辑从 UI 中抽离，支持多页面共享同一条链路。
- **运动配置层 (MotionConfig)**：实现“逻辑关节(J1..J6) ↔ 物理舵机ID”的持久化映射，并保存每个关节的 Min/Max/Home 参数。
- **运动控制层 (MotionController)**：
  - 支持多关节同步 Move（一帧内下发 6 路目标）。
  - 实现**关键帧脚本回放**机制（DemoPlay）。
  - 内置安全夹紧逻辑，确保所有高层运动指令不超出标定的安全范围。
- **运动诊断页 (MotionDiagPage)**：
  - **关节标定面板**：下拉选择 J1..J6，现场填入绑定的 ServoId、安全边界与中位。
  - **快速动作**：一键 MoveSelected、一键 Home（所有关节同步回中）、一键 ReadAll（读取 0x15 回读）。
  - **示例回放**：提供一个 5 帧的“摆动演示”脚本，支持循环播放。
- 关键文件：
  - 服务/逻辑：`ArmCommsService.h/.cpp`、`MotionConfig.h/.cpp`、`MotionController.h/.cpp`
  - UI：`MotionDiagPage.h/.cpp`

### 7) 参数导出/导入模块（多人共享支持）
- **功能**：将原本存储在 Windows 注册表中的持久化设置（Throttle、ServoLimits、CameraOverlay、MotionConfig 等）统一导出为可分发的 `.ini` 参数文件。
- **UI 入口**：主对话框新增 **“导出参数...”** 和 **“导入参数...”** 按钮。
- **同步机制**：导入完成后自动广播刷新消息，所有已打开的诊断页（Serial/Camera/Motion/Control）会立即重新加载最新参数，实现“无感同步”。
- 关键文件：
  - 逻辑：`SettingsIo.h/.cpp`、`AppMessages.h`
  - UI：`智能机械臂Dlg.cpp/.h`

## 当前可运行验证（快速自检清单）
- **编译**：`Debug|x64` 已验证可通过（0 warning / 0 error）
- **参数导出/导入自检**：
  - 在主界面点击 **“导出参数...”** → 保存为 `test.ini`。
  - 在 `Control` 页修改 Throttle 值（如改为 100ms）。
  - 在主界面点击 **“导入参数...”** → 选择刚才的 `test.ini`。
  - 观察 `Control` 页滑块是否自动跳回原值。
- **串口模拟自检**：
  - 打开诊断中心 → Serial 页 → 勾选“使用模拟串口”
  - **手动调试**：填 ID=1, Pos=500, Step=20 → 点 +步/-步 → 观察日志 TX/RX
  - **回读验证**：点“读取ID” → 观察日志 `[PARSE] ... RESP [1=xxx]`
- **运动联动自检**：
  - 打开诊断中心 → Motion 页。
  - **参数导入**：若在 Serial 页已设好限位，点“导入ServoLimits”可自动同步已绑定 ID 的限位。
  - **同步 Home**：设置好各关节 Home 点后，点 Home 观察日志是否一次性发出多路舵机的 `0x03` 指令。
  - **脚本回放**：点 DemoPlay，观察日志是否按设定的 Time 间隔自动滚动发送指令。
- **节流自检**：
  - 在 Control 页把 Throttle 设为 100ms
  - 在 Motion 页启动脚本，观察日志里的 TX 时间间隔严格符合 100ms 阈值。
- **摄像头自检**：
  - 有摄像头：Camera 页 → Start → 看到预览与 FPS
  - 无摄像头：Start → 自动进入 Test source（状态显示 Test source）
- **方向与叠加自检**：
  - Camera 页勾选 Mirror/Crosshair/Grid、切换 Rot
  - 观察画面变化，退出程序再进来确认设置仍保留

## 已知限制（为后续迭代预留）
- **旋转实现**：当前旋转采用 CPU 侧的最近邻映射（便于调试与低依赖），效果以“快速适配安装方向”为主。
- **多舵机联动**：目前的 UI 侧重于单舵机调试和校准，多舵机联动控制（逆运动学等）将在主界面进一步实现。
