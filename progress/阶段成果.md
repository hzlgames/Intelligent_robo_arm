# 现阶段成果（智能机械臂控制软件 - 运动学 / 操作台 / 视觉闭环）

更新时间：2025-12-26

## 已实现内容总览

### 1) 5-DOF + 夹爪运动学算法 (ArmKinematics)
- **几何模型**：基于 Reference/mechanics.md 建立的 5 自由度（底座旋、肩、肘、腕俯仰、末端旋转）数学模型。
- **正运动学 (FK)**：实时计算关节角 $\theta_1..\theta_4$ 对应的末端坐标 $(x, y, z)$ 与俯仰角 $pitch$。
- **逆运动学 (IK)**：
  - 给定 $(x, y, z, pitch)$ 自动求解 4 组关节角。
  - **解优化**：内置“距离当前姿态最近”与“软限位优先”的择优算法，确保 Jog 移动平滑。
  - **失败原因解释**：当目标不可达或超限时，提供明确的文字反馈（如“超出物理触及范围”）。
- **坐标映射**：实现了“角度(Rad) ↔ 舵机PWM(0..1000)”的精准转换，支持两点标定与轴向修正。

### 2) 主界面升级为“全功能操作台”
- **布局自适应**：支持窗口自由缩放与最大化，视频区自动填充，控件智能锚定。
- **串口快捷入口**：在主界面顶栏直接选择 COM、连接/断开、切换模拟模式，并实时显示连接状态。
- **相机控制集成**：集成镜像、旋转、参考线开关，支持设置持久化。
- **状态监视器**：实时显示当前末端位姿 $(X, Y, Z, P)$ 及通信频率（TX FPS）。

### 3) Jog 笛卡尔空间控制 (JogController)
- **手感优化**：实现了“按住持续移动、松开即停”的摇杆式体验。
- **多模态输入**：
  - **键盘**：`WASD` 控制平面 X/Y，`QE` 控制高度 Z，`RF` 控制俯仰 Pitch。
  - **Shift 加速**：按住 Shift 速度倍增。
  - **虚拟摇杆**：右侧黑框区支持鼠标拖拽，模拟比例摇杆控制 X/Y。
- **安全保障**：Jog 过程中实时校验 IK 可达性，并在失败时自动停止下发，防止指令堆积导致机械臂失控。

### 4) 视觉协同控制与 HUD 增强 (Visual Servo)
- **视觉伺服控制器 (VisualServoController)**：
  - **指向运动算法**：实现了基于相机坐标系射线的平移增量计算。支持 `advance` 参数驱动末端沿光轴或指定射线 $R(rx, ry, rz)$ 推进/拉远。
  - **Look-and-Move 策略**：内置“先居中、再推进”的复合控制逻辑，当像素误差大于死区时优先对准，对准后才激活推进指令。
  - **距离闭环**：在具备深度观测时，支持基于 `desiredDepth` 的自动距离维持。
- **主界面全链路接入**：
  - **点击测算**：支持在视频区点击直接生成视觉观测点（模拟识别），测试闭环响应。
  - **覆盖控制**：支持“视觉优先”或“手动优先”模式切换。
- **视觉 HUD 2.0**：
  - 在画面上实时绘制**误差矢量箭头**与目标指示点。
  - 动态显示 VS 运行状态、当前模式以及归一化推进量。

### 5) 视觉算法接入与多模式识别（VisionService）
- **独立视觉线程**：新增 `VisionService`，从预览管线中安全取帧并处理，避免 UI/预览线程做重计算导致掉帧。
- **统一数据接口**：视觉模块统一输出 `VisualObservation`（u/v、置信度、时间戳；可选深度/射线），由 `VisualServoController` 消费并驱动现有 Jog/IK 链路。
- **多模式识别（可切换/可回退）**：
  - **BrightestPoint**：最亮点追踪（最小依赖，用于验证链路）。
  - **ColorTrack**：HSV 红色块追踪（快速验证稳定性）。
  - **Aruco**：ArUco 检测（优先级最高，稳定性最好）。
  - **Hand**：红+蓝双色贴纸，生成指向射线（用于 FollowRay/指向运动验证）。
  - **Detector**：OpenCV DNN 目标检测（ONNX；支持中文路径通过“读入内存再加载”规避兼容性问题）。
- **几何基础层**：新增 `VisionGeometry`（像素→射线、射线→平面交点、Marker 平面推导等），为后续 3D 定位与标定打底。
- **参数持久化/可共享**：视觉参数纳入 `.ini` 导入导出（`Vision` / `Vision\\Aruco` / `Vision\\Detector`），支持导入后热更新。

### 6) 工程化：OpenCV/vcpkg 依赖可复现 + 跨机器同步
- **vcpkg manifest**：项目根目录提供 `vcpkg.json`，声明依赖 `eigen3`、`opencv4[contrib]`、`ceres`，实现“拉代码即可按清单装库”。
- **OpenCV 生效状态提示**：主界面 `VS:` 状态行显示 `cv=Y/N`，用于快速判断 OpenCV 头文件是否进入编译环境。
- **中文路径安装崩溃规避**：将 vcpkg 安装目录固定到纯英文路径 `$(USERPROFILE)\vcpkg_installed\`（避免 vcpkg 内部工具在中文路径下异常退出，导致 `eigen3 BUILD_FAILED / 0xC0000409`）。
- **OpenCV include 路径兼容**：OpenCV4 头文件位于 `include/opencv4/opencv2/...`，项目已补齐 `include/opencv4` 到 include 搜索路径，确保 `#include <opencv2/...>` 可用。
- **OpenCV 4.12 ArUco API 兼容修复**：适配 `DetectorParameters` 不再提供 `create()`、`detectMarkers()` 参数类型变更（`Dictionary` → `Ptr<Dictionary>`），保证 `Aruco` 模式可编译运行。

---

## 当前可运行验证（快速自检清单）
- **运动学验证**：
  - 连接串口/模拟串口 → 观察主界面 `Pose` 坐标是否随回读/Home 改变。
- **Jog 功能验证**：
  - 勾选“模拟”并连接 → 在右侧 JogPad 拖拽或按 `WASD` → 观察日志是否有连续的 `0x03` 指令发出。
  - 尝试将 Z 设得很低 → 观察状态栏是否提示“IK 失败（不可达）”。
- **UI 布局验证**：
  - 拖动窗口边缘、点击最大化 → 检查视频区域是否拉伸、按钮是否保持整齐、D3D 画面是否正常。
- **视觉闭环验证（无机械臂也能做）**：
  - 打开预览 → 勾选 `VS Enable` → 用鼠标在视频区点击 → 观察目标点/误差箭头立即响应。
  - 用手机手电筒/红色物体/ArUco 码 → 观察目标点是否稳定锁定并跟随。
  - 导出 `.ini` 修改 `Vision` 参数后导入 → 观察效果立刻变化（热更新生效）。

## 下阶段重点
- **外参/尺度标定工程化**：把相机内参/外参（含桌面平面、相机相对末端位姿）做成“引导式标定”流程，降低现场部署成本。
- **交互闭环**：从“能跟随”升级到“能锁定/能取消/能急停”的可验收交互状态机（为 SeeAndFetch 抓取流程铺路）。
