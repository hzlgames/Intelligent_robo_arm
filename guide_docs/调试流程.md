# 调试流程

更新时间：2025-12-25

这份文档的目标是：**哪怕你暂时没有机械臂，也能把软件跑起来、把串口/摄像头调通，并且留好硬件到手后的安全联调路线**。

---

## 0. 你需要准备什么（最少准备）

### 0.1 软件环境

- Windows 10/11
- Visual Studio 2022（能打开并编译 `.sln`，建议安装“使用 C++ 的桌面开发”工作负载）
- Git（用于 clone 仓库与更新 vcpkg）

### 0.1.1 VS 需要勾选哪些组件？（新手照抄）

打开 Visual Studio Installer → 修改 VS2022 → 勾选：
- **工作负载**：使用 C++ 的桌面开发
- **可选组件（建议）**：
  - Windows 10/11 SDK
  - C++ MFC for latest v143 build tools（MFC 工程必需）
  - C++ CMake tools for Windows（可选，但推荐）

### 0.2 你要知道的 5 个词（不用背，遇到再回来查）

- **COM 口**：串口设备在 Windows 里的名字，比如 `COM3`、`COM11`。
- **TX / RX**
  - TX：你发出去的数据（发送）
  - RX：你收到的数据（接收）
- **FPS**：画面每秒更新多少帧（帧率）。越高越流畅。
- **hr=0x...**：摄像头/系统接口报错码（HRESULT）。看到它就说明“哪里失败了”，不是你“没点对”。
- **Test source**：没有摄像头/摄像头打不开时，程序会自动切换的“测试画面”，用来保证你还能继续调试界面流程。

### 0.3 多人协作技巧（必读）

由于大家电脑不同，注册表设置是互不通用的。为了保证 GitHub 协作时大家用的“安全边界”和“关节映射”一致：

- **提交代码前**：在主界面点 **“导出参数...”**，将生成的 `.ini` 提交到 Git。
- **拉取代码后**：在主界面点 **“导入参数...”**，加载队友的 `.ini`。

### 0.4 第三方库依赖（必须了解一次）

本项目用 **vcpkg manifest** 管理第三方库（清单在项目根目录 `vcpkg.json`）：
- **Eigen3**：运动学/几何计算
- **OpenCV4（含 contrib）**：视觉算法（Aruco / 色块 / DNN 等）
- **Ceres Solver**：标定优化（后续会用得更多）

你不需要手动下载这些库；正确配置一次 vcpkg 后，VS 会在编译时自动安装/引用。

### 0.5 网络慢怎么办？（支持你用 QQ 传输离线加速）

如果队友的网络下载 vcpkg 依赖很慢，你可以把你电脑上“已经下载/已经安装”的部分打包发给队友，显著加速。

#### 方案 A（最省心，体积较大）：整套离线包

把下面两个目录打包（zip/7z 都行）通过 QQ 传输给队友：
- **vcpkg 本体**：`C:\vcpkg\`
- **已安装依赖**（纯英文路径，避免中文路径坑）：`C:\Users\你的用户名\vcpkg_installed\`

队友收到后：
1. 解压到同样的位置（建议也用 `C:\vcpkg\`）
2. 确保他自己的安装目录在：`C:\Users\他的用户名\vcpkg_installed\`
3. 在管理员 PowerShell 执行一次（只做一次）：

```bat
cd /d C:\vcpkg
vcpkg integrate install
```

然后打开工程重新生成即可（多数情况下不会再下载）。

#### 方案 B（更小，但第一次仍可能会编译）：只共享缓存

把下面目录打包给队友（这会让 vcpkg **从本地缓存“秒装”很多包**）：
- vcpkg 下载缓存：`C:\vcpkg\downloads\`
- vcpkg 二进制缓存：`C:\Users\你的用户名\AppData\Local\vcpkg\archives\`

队友把它们合并到对应目录后，再编译工程，vcpkg 会尽量从缓存还原，减少下载与编译时间。

---

## 1. 先跑通最小闭环（无硬件也能完成，建议第一次就做这个）

### 1.1 编译并运行

1. 用 VS 打开 `智能机械臂.sln`
2. 选择 `Debug | x64`
3. 生成/运行（F5 或 Ctrl+F5）

你应该看到：

- 主窗口能打开
- 底部有 **“诊断(&D)…”** 按钮

### 1.2 打开“诊断中心”

1. 主窗口点击 **“诊断(&D)…”**
2. 会出现四页：`串口` / `摄像头` / `节流/控制` / `运动`

---

## 2. 串口调试（从“模拟串口”开始，0 成本验证协议）

### 2.1 用模拟串口跑通（推荐必做）

1. 诊断中心 → `串口` 页
2. 勾选 **“使用模拟串口”**
3. 点击 **连接/断开**（此时会连到模拟串口）
4. 点击 **示例Move**

你应该看到日志里依次出现：

- `[TX] ...`（你发出的一串十六进制）
- `[RX] ...`（模拟器回包的一串十六进制）
- `[PARSE] cmd=0x15 ...`（解析摘要）

如果你没看到：

- 只看到 `[WARN] Not connected.`：说明你忘了点“连接/断开”
- 只看到 `[TX]` 没有 `[RX]`：通常是没勾选模拟串口或没连上（再点一次连接）

### 2.2 用真实串口（有 USB-串口板/机械臂控制板时）

1. 取消勾选 **“使用模拟串口”**
2. 下拉框选一个 `COMx`
3. 点击 **连接/断开**
4. 点击发送测试帧（示例Move 或 读1..6）

你应该看到：

- 至少有 `[TX]`
- 如果对端会回包，你会看到 `[RX]` 和 `[PARSE]`

常见坑（按概率排序）：

1. **串口被占用**：关掉串口调试助手/Arduino IDE/上位机等
2. **驱动没装**：设备管理器里看不到 COM
3. **线/供电问题**：连接成功但设备不响应（需要对端设备正常上电）

### 2.3 新版串口界面图解（重要！）

为了方便你明天现场调试，界面上加了一组**“单舵机调试面板”**：

- **ID**：你要动哪个舵机（1~6）
- **Pos**：目标位置（0~1000）
- **Step**：步进量（默认 20，想微调就改小）
- **Time**：动作时间（默认 800ms）
- **-步 / +步**：按 Step 增减 Pos 值，点一下动一下。
- **发送Move**：把当前 ID/Pos 发出去。
- **读取ID**：只读当前这个舵机的角度。
- **设Min / 设Max**：把你当前试出来的“安全边界”存下来（以后动这个舵机就不会超出这个范围）。

---

## 3. 摄像头调试（先保证“能看到画面或测试源”，再谈效果）

### 3.1 基本预览（有摄像头更好，没有也能做）

1. 诊断中心 → `摄像头` 页
2. 点击 **Start**

你可能看到两种情况：

- **Previewing - xx FPS**：摄像头可用，已正常预览
- **Test source - 30.0 FPS**：摄像头不可用/初始化失败，自动切测试画面（这不是失败，是“保底机制”）

### 3.2 摄像头位置/方向变化怎么快速适配（你说摄像头可能会调整）

在 `Camera` 页尝试：

- **Mirror**：左右镜像（适合安装左右反了）
- **Rot**：0/90/180/270（适合竖着装/倒装）
- **Crosshair**：十字线（方便对准中心）
- **Grid**：九宫格参考线（方便对齐）

你应该看到：

- 画面实时变化（镜像/旋转/叠加线条）
- 退出程序再打开，设置仍然保留（已做持久化）

### 3.3 截图（强烈建议用来做“位置变化前后对比”）

1. 在 `Camera` 页点击 **Screenshot**
2. 选择保存位置（BMP）

建议命名方式（不费脑子）：

- `cam_日期_位置_rot_是否mirror.bmp`
- 例：`cam_2025-12-23_posA_rot90_mirror0.bmp`

### 3.4 摄像头打不开怎么办（新手最常见）

现象：点 Start 后总是 Test source，或者日志里有 `hr=0x...`

按顺序排查：

1. Windows 隐私设置：允许桌面应用访问摄像头
2. 先打开系统“相机”应用看它能不能用
3. 拔插摄像头/换 USB 口
4. 重启电脑（是真的有效）

---

## 4. 视觉闭环调试（Vision Servo：无机器验证算法的关键）

> **一句话目标**：在没有机械臂实物时，利用电脑摄像头验证“画面里的目标 -> 机械臂的运动趋势”是否正确。

### 4.1 开启视觉管线

1. 主界面点击 **“开始”**（启动预览）。
2. 勾选 **“VS Enable”**。

**预期现象**：
- 画面上出现一个**目标点（圆圈）**和一条**误差箭头**（从中心指向目标）。
- 右侧状态栏 `VS:` 从 `OFF` 变为 `ON` 或 `IDLE`。

### 4.2 验证不同识别模式（默认 Auto）

视觉系统会自动根据画面内容切换算法（优先级：ArUco > 红色色块 > 最亮点）：

1. **最亮点追踪**：找个手机手电筒照镜头，目标点应死死锁在光斑上。
2. **红色物体追踪（色块）**：拿一个红色的盖子或贴纸，目标点应锁在红色中心。
3. **ArUco 标记（最推荐）**：打印或在手机上显示一张 `4x4_50` 的 ArUco 码（ID随意），目标点会稳定锁在码中心。
   - *进阶*：ArUco 模式下会自动估算深度，你会发现 `Pose` 里的 Z 轴数值会随相机远近变化。

### 4.3 验证“指向运动”（红+蓝双色贴纸）

目标：验证机械臂是否能顺着你“指的方向”前进。

1. **准备**：在左手大拇指贴红贴纸，食指贴蓝贴纸。
2. **模式**：主界面下拉框选 **“沿指向(FollowRay)”**。
3. **操作**：
   - 左右晃动手，观察误差箭头是否跟随。
   - 推动 **“Advance”** 滑条到正值。
   - **预期**：你会看到日志里的位姿目标正在顺着“红->蓝”构成的连线方向移动。

### 4.4 模拟点击调试

如果手边没有任何道具，在 **“VS Enable”** 开启状态下，直接在视频区**鼠标左键点击**。

- **现象**：目标点会立刻跳到你点击的位置，机械臂会产生“指过去”的趋势。
- **用途**：这是最快验证运动学正逆解是否被视觉正确驱动的方法。

> 注意：如果你的“识别模式”不是 **手动(点击)**，视觉线程会持续用算法输出覆盖点击点，
> 看起来就会像“怎么点都回到天花板灯/某个最亮点”。此时把右侧 **识别模式** 切到 **手动(点击)** 再测。

### 4.5 常见问题排查

- **目标点乱跳**：环境太杂。建议在白墙或纯色桌面下测试；或者调大 `emaAlpha`（在 `Vision` 参数段）。
- **VS 状态显示 Inactive**：可能是置信度太低（物体太小）或画面太暗。
- **画面卡顿**：正常现象。视觉算法运行在独立线程，不会卡死预览，但如果电脑 CPU 较弱，检测帧率（proc FPS）会下降。

### 4.6 视觉参数怎么改？（INI 导入导出是最快的）

视觉相关参数目前统一走 **“导出参数 / 导入参数”** 的 `.ini` 文件（便于多人协作、快速复现实验环境）。

1. 在主界面点击 **“导出参数...”**，生成一份 `.ini`。
2. 用记事本/VS Code 打开该 `.ini`，你会看到类似这些段（名称可能略有差异，但结构一致）：
   - `Vision`：通用参数（模式、周期、采样步长、平滑系数等）
   - `Vision\Aruco`：ArUco 相关参数（例如 marker 边长）
   - `Vision\Detector`：Detector 相关参数（ONNX 路径、输入尺寸、阈值等）
3. 修改后回到软件点击 **“导入参数...”**。

**预期现象**：
- 导入后立即生效（已支持热更新）。
- 即使视觉线程正在跑，也不会崩溃（已做线程安全保护）。

> 小建议：调参时每次只改 1 个量，并且导出文件命名带上关键参数，例如：`vision_aruco40mm_alpha035.ini`，便于回滚与对比。

### 4.7 Detector（ONNX）怎么验证？（可选）

如果你想验证 DNN Detector 管线（无需机械臂）：

1. 先准备一个 ONNX 模型文件（路径允许包含中文）。
2. 导出 `.ini` 后，在 `Vision\Detector` 段填入 ONNX 路径与输入尺寸（例如 320x320），同时把 `conf/nms` 阈值设为一个合理值（比如 conf=0.5，nms=0.4）。
3. 导入 `.ini`，打开预览并勾选 **“VS Enable”**。
4. 把一个明显目标放进镜头（人、杯子、鼠标等，取决于模型类别）。

**预期现象**：
- 如果模型输出正常，目标点会跟随检测框中心。
- 如果模型/类别不匹配，可能无输出，这是正常现象（先用 ArUco/红色块验证主链路）。

**常见坑**：
- 模型太大/CPU 太慢：`proc FPS` 会明显下降（说明推理吃满了）。
- 路径/权限问题：导入后日志会提示 “Failed to read ONNX file …” 之类信息（重新选路径或换到无权限限制目录）。

### 4.8 让 OpenCV 真正生效（推荐：vcpkg manifest）

你看到“有 e(x,y) 但画面没有 OpenCV 文本/HUD、也无法使用 ArUco/色块/Detector”等，通常是因为 **OpenCV 没有进入编译环境**。

本工程已经启用了 vcpkg manifest（项目文件里 `VcpkgEnableManifest=true`，并提供了 `vcpkg.json` 依赖清单），你只需要把 vcpkg 配好即可。

**步骤（最小白，照抄即可）**：

> 目标：让 VS 自动按 `vcpkg.json` 安装 `opencv4`，并让代码能 `#include <opencv2/...>`。

#### A) 一次性安装 vcpkg（只做一次）
1. 找一个纯英文路径（强烈推荐）：`C:\vcpkg`
2. 打开 Windows 终端（PowerShell 或 CMD），逐行执行：

```bat
cd /d C:\
git clone https://github.com/microsoft/vcpkg C:\vcpkg
cd /d C:\vcpkg
bootstrap-vcpkg.bat
vcpkg integrate install
```

> 说明：`integrate install` 会让 VS/MSBuild 能自动找到 vcpkg。

#### B) 让 VS 自动按 manifest 安装依赖（每台机器第一次会做）
1. 用 VS2022 打开 `智能机械臂.sln`
2. 选择 `Debug | x64`
3. 直接点“生成/重新生成”
4. 如果 VS 弹窗提示“根据 vcpkg manifest 安装依赖”，点 **是/允许**

#### C) 验收：怎么确认 OpenCV 已经生效？
1. 重新运行程序
2. 右侧 `VS:` 状态行应显示 `cv=Y`

> 如果还是 `cv=N`：
> - 先 **重启 VS** 再编译一次（最常见）
> - 确认 vcpkg 安装路径确实是 `C:\vcpkg`（不要放中文/空格路径）
> - 确认 `vcpkg integrate install` 执行成功

**如何确认已经生效**：
- 主界面右侧 `VS:` 状态行会显示 `cv=Y`（表示 OpenCV 头文件已被编译器找到）。
- 若仍显示 `cv=N`，说明 vcpkg/VS 组件未配置到位（需要先把 vcpkg 安装好，或更新 VS 到带 vcpkg manifest 支持的版本）。

#### D) 如果你在“中文路径工程”里遇到 eigen3 BUILD_FAILED（cmake.exe 退出码 0xC0000409）

这类报错的根因通常不是 eigen3 本身，而是 vcpkg 在 port 的后处理阶段会调用一些工具（例如 `pkgconf`）；
当 `--x-install-root` 指向包含中文的路径时，个别工具会触发崩溃，导致 vcpkg 报 `BUILD_FAILED`。

**解决办法（推荐）**：把 vcpkg 安装目录改到纯英文路径。

- 本工程已在 `智能机械臂.vcxproj` 里设置了：
  - `VcpkgInstalledDir = $(USERPROFILE)\\vcpkg_installed\\`
- 你只要重新生成即可；vcpkg 会把依赖装到 `C:\\Users\\你的用户名\\vcpkg_installed\\`（纯英文）。

#### E) 如果你已经看到 cv=Y，但编译报 ArUco 相关错误（OpenCV 4.12+）

从 OpenCV 4.12 开始，Aruco 的部分 API 有变更（例如 `DetectorParameters::create()` 不存在、`detectMarkers()` 需要 `Ptr<Dictionary>`）。
本工程已做了兼容修复；如果你拉到旧分支遇到报错，更新到最新代码即可。

---

## 5. 节流（Throttle）是什么？你要怎么用？

> 一句话：节流就是“别发太快”，避免串口被刷爆、舵机抖动。

### 5.1 调参位置

诊断中心 → `节流/控制` 页

- `Throttle (ms)`：范围 30~100ms
- **Send rate**：真实发送帧率（如果不发数据这里就是 0）
- **Last send**：距离上次发送过了多少毫秒

推荐新手默认：

- **50ms**（稳定、不会太慢）

说明：

- 这个参数会保存，下次打开仍然生效。
- **现在串口页的所有发送按钮（包括点得很快的“+步”）都会自动排队，间隔不会小于这个设定值。**

---

## 6. 机械臂到手后的安全联调（按顺序做，能明显减少翻车）

### 6.1 上电前（最重要）

- 固定机械臂，周围不要放水杯/手机/手
- 供电要稳（舵机电流很大，别用“看起来能亮”的弱供电）
- 第一次动作建议慢一点（Time 设 800~1500ms）

### 6.2 单舵机小步（别一上来 6 个一起动）

目标：确认“舵机 ID ↔ 物理关节”、方向是否反、范围是否安全。

建议你准备一张表，照着填：

- 舵机 1：对应关节 ______，正方向是 ______
- 舵机 2：对应关节 ______，正方向是 ______
- ...

**操作步骤**：

1. 在串口页填好 **ID=1**，**Pos=500**（中间值），**Step=20**。
2. 点 **+步** 或 **-步**，观察舵机反应。
   - 如果动得太猛，把 Time 改大（比如 1500）。
   - 如果没反应，检查 ID 是不是写错了。
3. 任何“顶住/异响/卡住”立刻停止（断电/急停）。

### 6.3 找每路安全范围（min/max）

因为我们默认假设 0~1000，但真实机械臂可能不是全范围都安全。

**做法**：

1. 慢慢点 **-步**，直到看到关节快碰到限位或者线拉紧了。
2. 回退一点点（按 **+步**），然后点 **设Min**。
   - 此时日志会提示 `[INFO] 舵机1 min=xxx 已保存`。
3. 同理往大方向试探，找到最大安全值，点 **设Max**。
4. **从此以后，这路舵机你随便点 +步/-步，软件都会帮你自动夹在这个范围内，不会发出去危险值。**

### 6.4 如果支持 0x15 回读（可选但很有用）

1. 发送一次动作后，点 **读取ID**。
2. 看日志：`[PARSE] cmd=0x15 RESP [1=502]`。
3. 对比：你发的 Pos 是 500，回读是 502 → 误差 2，很正常。
   - 如果你发 500，回读 200 → 说明舵机可能没劲了（欠压）或者卡住了。
   - 如果误差很大：
     - 先查供电/负载/舵机打滑
     - 再查是否发得太频繁（节流设太小）

---

## 7. 运动控制调试（Motion 页：多舵机联动与标定）

> 目标：将物理舵机 ID 对应到逻辑关节（J1..J6），并实现“一键归位”与“自动演示”。

### 7.1 为什么要用 Motion 页？

虽然 Serial 页可以动舵机，但它是“一次动一个”。**Motion 页支持联动**，比如你可以让 6 个舵机在 1.5 秒内同步动到特定姿态（Home 点），这是后续开发复杂轨迹的基础。

### 7.2 标定你的机械臂（现场第一步）

1. 诊断中心 → `运动` 页。
2. **连接**：方法同第 2 章（选 COM 或模拟器）。
3. **建立映射**：
   - 在“关节”下拉框选择 **`J1(底座旋转)`** 等具体关节。
   - 在 **`舵机ID`** 填入你在第 5.2 节试出来的真实 ID。
   - 点 **保存**（非常重要，不点不生效，配置会丢）。
   - 重复此步骤，把 J1..J6 全部填好。
4. **同步限位（偷懒技巧）**：
   - 如果你已经在串口页设好了 Min/Max，这里直接点 **“同步限位”**。
   - 软件会自动把对应 ID 的安全范围（最小/最大）同步过来，省得你再填一遍。

### 7.3 测试联动与一键归位

> **概念辨析：归位值 vs 目标值**
> - **归位值 (Home Position)**：**长期配置**。这是你希望机械臂“初始化”或“休息”时的默认姿态。点击“保存”后会存入电脑，点击“一键归位”时所有关节都会同步回到这个位置。
> - **目标值 (Target)**：**临时动作**。仅用于测试当前选中的这一个关节。它不会改变保存的配置，点完“执行”就失效了。

1. 设置好每个关节的 **`归位值`**（通常填 500，或者你觉得顺眼的任何姿态）。
2. 在 **`目标`** 和 **`时间(ms)`** 填入你想试的值（比如 目标=600, 时间=1000）。
3. 点 **执行**：只动当前选中的这一个关节，测试单轴映射对不对。
4. 点 **一键归位**：**奇迹时刻**。你会看到日志里发出一帧 `cmd=0x03` 却带了 6 个舵机的数据，机械臂会整体平滑移动到你设定的姿态。
5. 点 **全轴回读**：批量读取所有已配置关节的当前位置（如果硬件支持）。

### 7.4 自动演示（演示脚本）

1. 确认 **J2(肩部)** 和 **J3(肘部)** 已正确配置 `舵机ID`（Demo 脚本默认摆动这两个关节）。
2. 勾选 **循环**。
3. 点击 **演示脚本**：机械臂将进入自动循环摆动模式。
4. 观察 `节流/控制` 页的 **Send rate**：你应该能看到稳定的发送频率。
5. 点击 **停止**：立即停止所有脚本动作并清空队列。

---

## 8. 最快验收（适合写实验报告/答辩演示）

你至少准备 4 张截图/证据：

1. `串口` 页：模拟串口下发 Move 或 Read 的日志。
2. `摄像头` 页：预览画面 + 十字线。
3. `节流/控制` 页：Throttle=50ms 时稳定的发送帧率截图。
4. `运动` 页：点击 **一键归位** 后的日志截图（显示一帧内包含多路舵机数据 `servos=6`）。

---

## 9. 团队协作：如何同步大家的标定结果？

如果你在实验室调好了机械臂的 `Min/Max` 和 `关节映射`，想让队友在宿舍模拟时也能用这一套参数：

1. **导出**：在主界面点击 **“导出参数...”**，保存为 `lab_arm_config.ini`。
2. **共享**：把这个文件发给队友，或者提交到 GitHub 仓库。
3. **导入**：队友打开软件，点击 **“导入参数...”**，加载该文件。
4. **生效**：队友打开“诊断中心”，会发现他的 `串口` 限位和 `运动` 关节映射已经变成和你一模一样的了。
