# 调试流程（新手版：普通大学生可直接照做）

更新时间：2025-12-23

这份文档的目标是：**哪怕你暂时没有机械臂，也能把软件跑起来、把串口/摄像头调通，并且留好硬件到手后的安全联调路线**。

---

## 0. 你需要准备什么（最少准备）

### 0.1 软件环境
- Windows 10/11
- Visual Studio 2022（能打开并编译 `.sln`）

### 0.2 你要知道的 5 个词（不用背，遇到再回来查）
- **COM 口**：串口设备在 Windows 里的名字，比如 `COM3`、`COM11`。
- **TX / RX**
  - TX：你发出去的数据（发送）
  - RX：你收到的数据（接收）
- **FPS**：画面每秒更新多少帧（帧率）。越高越流畅。
- **hr=0x...**：摄像头/系统接口报错码（HRESULT）。看到它就说明“哪里失败了”，不是你“没点对”。
- **Test source**：没有摄像头/摄像头打不开时，程序会自动切换的“测试画面”，用来保证你还能继续调试界面流程。

### 0.3 多人协作技巧（必读）
由于大家电脑不同，注册表设置是互不通用的。为了保证 GitHub 协作时大家用的“安全边界”和“关节映射”一致：
- **提交代码前**：在主界面点 **“导出参数...”**，将生成的 `.ini` 提交到 Git。
- **拉取代码后**：在主界面点 **“导入参数...”**，加载队友的 `.ini`。

---

## 1. 先跑通最小闭环（无硬件也能完成，建议第一次就做这个）

### 1.1 编译并运行
1. 用 VS 打开 `智能机械臂.sln`
2. 选择 `Debug | x64`
3. 生成/运行（F5 或 Ctrl+F5）

你应该看到：
- 主窗口能打开
- 底部有 **“诊断(&D)…”** 按钮

### 1.2 打开“诊断中心”
1. 主窗口点击 **“诊断(&D)…”**
2. 会出现三页：`Serial` / `Camera` / `Control`

---

## 2. 串口调试（从“模拟串口”开始，0 成本验证协议）

### 2.1 用模拟串口跑通（推荐必做）
1. 诊断中心 → `Serial` 页
2. 勾选 **“使用模拟串口”**
3. 点击 **连接/断开**（此时会连到模拟串口）
4. 点击 **发送示例Move**

你应该看到日志里依次出现：
- `[TX] ...`（你发出的一串十六进制）
- `[RX] ...`（模拟器回包的一串十六进制）
- `[PARSE] cmd=0x15 ...`（解析摘要）

如果你没看到：
- 只看到 `[WARN] Not connected.`：说明你忘了点“连接/断开”
- 只看到 `[TX]` 没有 `[RX]`：通常是没勾选模拟串口或没连上（再点一次连接）

### 2.2 用真实串口（有 USB-串口板/机械臂控制板时）
1. 取消勾选 **“使用模拟串口”**
2. 下拉框选一个 `COMx`
3. 点击 **连接/断开**
4. 点击发送测试帧（示例Move 或 读1..6）

你应该看到：
- 至少有 `[TX]`
- 如果对端会回包，你会看到 `[RX]` 和 `[PARSE]`

常见坑（按概率排序）：
1. **串口被占用**：关掉串口调试助手/Arduino IDE/上位机等
2. **驱动没装**：设备管理器里看不到 COM
3. **线/供电问题**：连接成功但设备不响应（需要对端设备正常上电）

### 2.3 新版串口界面图解（重要！）
为了方便你明天现场调试，界面上加了一组**“单舵机调试面板”**：

- **ID**：你要动哪个舵机（1~6）
- **Pos**：目标位置（0~1000）
- **Step**：步进量（默认 20，想微调就改小）
- **Time**：动作时间（默认 800ms）
- **-步 / +步**：按 Step 增减 Pos 值，点一下动一下。
- **发送Move**：把当前 ID/Pos 发出去。
- **读取ID**：只读当前这个舵机的角度。
- **设Min / 设Max**：把你当前试出来的“安全边界”存下来（以后动这个舵机就不会超出这个范围）。

---

## 3. 摄像头调试（先保证“能看到画面或测试源”，再谈效果）

### 3.1 基本预览（有摄像头更好，没有也能做）
1. 诊断中心 → `Camera` 页
2. 点击 **Start**

你可能看到两种情况：
- **Previewing - xx FPS**：摄像头可用，已正常预览
- **Test source - 30.0 FPS**：摄像头不可用/初始化失败，自动切测试画面（这不是失败，是“保底机制”）

### 3.2 摄像头位置/方向变化怎么快速适配（你说摄像头可能会调整）
在 `Camera` 页尝试：
- **Mirror**：左右镜像（适合安装左右反了）
- **Rot**：0/90/180/270（适合竖着装/倒装）
- **Crosshair**：十字线（方便对准中心）
- **Grid**：九宫格参考线（方便对齐）

你应该看到：
- 画面实时变化（镜像/旋转/叠加线条）
- 退出程序再打开，设置仍然保留（已做持久化）

### 3.3 截图（强烈建议用来做“位置变化前后对比”）
1. 在 `Camera` 页点击 **Screenshot**
2. 选择保存位置（BMP）

建议命名方式（不费脑子）：
- `cam_日期_位置_rot_是否mirror.bmp`
- 例：`cam_2025-12-23_posA_rot90_mirror0.bmp`

### 3.4 摄像头打不开怎么办（新手最常见）
现象：点 Start 后总是 Test source，或者日志里有 `hr=0x...`

按顺序排查：
1. Windows 隐私设置：允许桌面应用访问摄像头
2. 先打开系统“相机”应用看它能不能用
3. 拔插摄像头/换 USB 口
4. 重启电脑（是真的有效）

---

## 4. 节流（Throttle）是什么？你要怎么用？

> 一句话：节流就是“别发太快”，避免串口被刷爆、舵机抖动。

### 4.1 调参位置
诊断中心 → `Control` 页
- `Throttle (ms)`：范围 30~100ms
- **Send rate**：真实发送帧率（如果不发数据这里就是 0）
- **Last send**：距离上次发送过了多少毫秒

推荐新手默认：
- **50ms**（稳定、不会太慢）

说明：
- 这个参数会保存，下次打开仍然生效。
- **现在串口页的所有发送按钮（包括点得很快的“+步”）都会自动排队，间隔不会小于这个设定值。**

---

## 5. 机械臂到手后的安全联调（按顺序做，能明显减少翻车）

### 5.1 上电前（最重要）
- 固定机械臂，周围不要放水杯/手机/手
- 供电要稳（舵机电流很大，别用“看起来能亮”的弱供电）
- 第一次动作建议慢一点（Time 设 800~1500ms）

### 5.2 单舵机小步（别一上来 6 个一起动）
目标：确认“舵机 ID ↔ 物理关节”、方向是否反、范围是否安全。

建议你准备一张表，照着填：
- 舵机 1：对应关节 ______，正方向是 ______
- 舵机 2：对应关节 ______，正方向是 ______
- ...

**操作步骤**：
1. 在串口页填好 **ID=1**，**Pos=500**（中间值），**Step=20**。
2. 点 **+步** 或 **-步**，观察舵机反应。
   - 如果动得太猛，把 Time 改大（比如 1500）。
   - 如果没反应，检查 ID 是不是写错了。
3. 任何“顶住/异响/卡住”立刻停止（断电/急停）。

### 5.3 找每路安全范围（min/max）
因为我们默认假设 0~1000，但真实机械臂可能不是全范围都安全。

**做法**：
1. 慢慢点 **-步**，直到看到关节快碰到限位或者线拉紧了。
2. 回退一点点（按 **+步**），然后点 **设Min**。
   - 此时日志会提示 `[INFO] 舵机1 min=xxx 已保存`。
3. 同理往大方向试探，找到最大安全值，点 **设Max**。
4. **从此以后，这路舵机你随便点 +步/-步，软件都会帮你自动夹在这个范围内，不会发出去危险值。**

### 5.4 如果支持 0x15 回读（可选但很有用）
1. 发送一次动作后，点 **读取ID**。
2. 看日志：`[PARSE] cmd=0x15 RESP [1=502]`。
3. 对比：你发的 Pos 是 500，回读是 502 → 误差 2，很正常。
   - 如果你发 500，回读 200 → 说明舵机可能没劲了（欠压）或者卡住了。
   - 如果误差很大：
     - 先查供电/负载/舵机打滑
     - 再查是否发得太频繁（节流设太小）

---

## 5. 运动控制调试（Motion 页：多舵机联动与标定）

> 目标：将物理舵机 ID 对应到逻辑关节（J1..J6），并实现“一键归位”与“自动演示”。

### 5.1 为什么要用 Motion 页？
虽然 Serial 页可以动舵机，但它是“一次动一个”。**Motion 页支持联动**，比如你可以让 6 个舵机在 1.5 秒内同步动到特定姿态（Home 点），这是后续开发复杂轨迹的基础。

### 5.2 标定你的机械臂（现场第一步）
1. 诊断中心 → `Motion` 页。
2. **连接**：方法同第 2 章（选 COM 或模拟器）。
3. **建立映射**：
   - 下拉选 `J1(BaseYaw)`。
   - 在 `ServoId` 填入你在第 5.2 节试出来的 ID。
   - 点 **Save**（非常重要，不点不生效）。
   - 重复此步骤，把 J1..J6 全部填好。
4. **一键导入限位**：
   - 如果你已经在 Serial 页设好了 Min/Max，直接点 **“导入ServoLimits”**，软件会自动把对应 ID 的安全范围同步过来。

### 5.3 测试联动与 Home
1. 设置好每个关节的 `Home` 坐标（通常填 500 左右你觉得顺眼的位置）。
2. 在 `Target` 和 `Time` 填入你想试的值（比如 Target=600, Time=1000）。
3. 点 **Move**：只动当前选中的这个关节。
4. 点 **Home**：**奇迹时刻**。你会看到日志里发出一帧 `cmd=0x03` 却带了 6 个舵机的数据，机械臂会整体平滑移动。
5. 点 **ReadAll**：批量读取所有已配置关节的当前位置。

### 5.4 自动演示（DemoPlay）
1. 确认 J2 和 J3 已正确配置 ServoId（Demo 脚本默认摆动这两个关节）。
2. 勾选 **Loop**（循环）。
3. 点击 **DemoPlay**：机械臂将进入自动循环摆动模式。
4. 观察 `Control` 页的 **Send rate**：你应该能看到稳定的发送频率。
5. 点击 **Stop**：立即停止所有脚本动作并清空队列。

---

## 6. 最快验收（适合写实验报告/答辩演示）
你至少准备 4 张截图/证据：
1. `Serial` 页：模拟串口下发 Move 或 Read 的日志。
2. `Camera` 页：预览画面 + 十字线。
3. `Control` 页：Throttle=50ms 时稳定的发送帧率截图。
4. `Motion` 页：点击 **Home** 后的日志截图（显示一帧内包含多路舵机数据 `servos=6`）。

---

## 7. 团队协作：如何同步大家的标定结果？

如果你在实验室调好了机械臂的 `Min/Max` 和 `JointID`，想让队友在宿舍模拟时也能用这一套参数：

1. **导出**：在主界面点击 **“导出参数...”**，保存为 `lab_arm_config.ini`。
2. **共享**：把这个文件发给队友，或者提交到 GitHub 仓库。
3. **导入**：队友打开软件，点击 **“导入参数...”**，加载该文件。
4. **生效**：队友打开“诊断中心”，会发现他的 `Serial` 限位和 `Motion` 关节映射已经变成和你一模一样的了。
